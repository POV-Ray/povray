/* ---------------------------------------------------------------------------
*  PALETTE.C
*
*
*  from POVLAB 3D Modeller
*  Copyright 1994-1999 POVLAB Authors.
*  ---------------------------------------------------------------------------
*  NOTICE: This source code file is provided so that users may experiment
*  with enhancements to POVLAB and to port the software to platforms other
*  than those supported by the POVLAB authors. There are strict rules under
*  which you are permitted to use this file. The rules are in the file
*  named LEGAL.TXT which should be distributed with this file.
*  If LEGAL.TXT is not available or for more info please contact the POVLAB
*  primary author by leaving a message on http://www.povlab.org
*  The latest and official version of POVLAB may be found at this site.
*
*  POVLAB was originally written by Denis Olivier.
*
*  ---------------------------------------------------------------------------*/

#include <MATH.H>
#include <FLOAT.H>
#include <CONIO.H>
#include <I86.H>
#include "LIB.H"
#include "GLOBAL.H"
#include "GLIB.H"

#define NBC 256

byte Palette[256][3]={
    0,  0,  0,     // 0
    0,  0,170,     // 1
    0,170,  0,     // 2
    0,170,170,     // 3
   51,159,255,     // 4
  170,  0,170,     // 5
  170, 85,  0,     // 6
  170,170,170,     // 7
  153,153,153,     // 8
   86, 86, 86,     // 9
   85,255, 85,     // 10
  255, 85, 85,     // 11
  255, 85,255,     // 12
  255,255,  0,     // 13
  255,255,255,     // 14
   21, 21, 21,     // 15
   47, 47, 47,     // 16
   69, 69, 69,     // 17
  110,110,110,     // 18
  202,202,202,     // 19
  224,224,224,     // 20
    0, 31,  0,     // 21
    0, 63,  0,     // 22
    0, 95,  0,     // 23
    0,127,  0,     // 24
    0,223,  0,     // 25
    0,255,  0,     // 26
   51,255,  0,     // 27
   51,223,  0,     // 28
   51,191,  0,     // 29
   51,159,  0,     // 30
   51,127,  0,     // 31
   51, 95,  0,     // 32
   51, 63,  0,     // 33
   51, 31,  0,     // 34
   51,  0,  0,     // 35
  102,  0,  0,     // 36
  102, 31,  0,     // 37
  102, 63,  0,     // 38
  102, 95,  0,     // 39
  102,127,  0,     // 40
  102,159,  0,     // 41
  102,191,  0,     // 42
  102,223,  0,     // 43
  102,255,  0,     // 44
  153,255,  0,     // 45
  153,223,  0,     // 46
  153,191,  0,     // 47
  153,159,  0,     // 48
  153,127,  0,     // 49
  153, 31,  0,     // 50
  204,  0,  0,     // 51
  204, 31,  0,     // 52
  204, 63,  0,     // 53
  204, 95,  0,     // 54
  204,127,  0,     // 55
  204,159,  0,     // 56
  204,191,  0,     // 57
  204,223,  0,     // 58
  204,255,  0,     // 59
  255,255, 85,     // 60
  255,223,  0,     // 61
  255,191,  0,     // 62
  255,159,  0,     // 63
  255,127,  0,     // 64
  255, 95,  0,     // 65
  255, 63,  0,     // 66
  255, 31,  0,     // 67
  255,  0,  0,     // 68
  255,  0, 85,     // 69
  255, 31, 85,     // 70
  255,127, 85,     // 71
  255,159, 85,     // 72
  255,191, 85,     // 73
  255,223, 85,     // 74
  204,255, 85,     // 75
  204,223, 85,     // 76
  204,191, 85,     // 77
  204,159, 85,     // 78
  204,127, 85,     // 79
  204, 95, 85,     // 80
  204, 63, 85,     // 81
  204, 31, 85,     // 82
  204,  0, 85,     // 83
  153,  0, 85,     // 84
  153, 31, 85,     // 85
  153, 63, 85,     // 86
  153, 95, 85,     // 87
  153,127, 85,     // 88
  153,159, 85,     // 89
  153,191, 85,     // 90
  153,223, 85,     // 91
  153,255, 85,     // 92
  102,223, 85,     // 93
  102,191, 85,     // 94
  102,159, 85,     // 95
  102,127, 85,     // 96
  102, 63, 85,     // 97
  102, 31, 85,     // 98
  102,  0, 85,     // 99
   51,  0, 85,     // 100
   51, 31, 85,     // 101
   51, 95, 85,     // 102
   51,127, 85,     // 103
   51,159, 85,     // 104
   51,191, 85,     // 105
   51,223, 85,     // 106
   51,255, 85,     // 107
    0,255, 85,     // 108
    0,223, 85,     // 109
    0,191, 85,     // 110
    0,159, 85,     // 111
    0,127, 85,     // 112
    0, 95, 85,     // 113
    0, 63, 85,     // 114
    0, 31, 85,     // 115
    0,  0, 55,     // 116
    0, 31,170,     // 117
    0, 63,170,     // 118
    0, 95,170,     // 119
    0,127,170,     // 120
    0,223,170,     // 121
    0,255,170,     // 122
   51,255,170,     // 123
   51,223,170,     // 124
   51,191,170,     // 125
   51,159,170,     // 126
   51,127,170,     // 127
   51, 95,170,     // 128
   51, 63,170,     // 129
   51, 31,170,     // 130
   51,  0,170,     // 131
  102,  0,170,     // 132
  102, 31,170,     // 133
  102, 63,170,     // 134
  102, 95,170,     // 135
  102,127,170,     // 136
  102,159,170,     // 137
  102,191,170,     // 138
  102,223,170,     // 139
  102,255,170,     // 140
  153,255,170,     // 141
  153,223,170,     // 142
  153,127,170,     // 143
  153, 95,170,     // 144
  153, 63,170,     // 145
  153, 31,170,     // 146
  204,  0,170,     // 147
  204, 31,170,     // 148
  204, 63,170,     // 149
  204, 95,170,     // 150
  204,127,170,     // 151
  204,159,170,     // 152
  204,191,170,     // 153
  204,223,170,     // 154
  204,255,170,     // 155
  255,255,170,     // 156
  255,223,170,     // 157
  255,191,170,     // 158
  255,159,170,     // 159
  255,127,170,     // 160
  255, 95,170,     // 161
  255, 63,170,     // 162
  255, 31,170,     // 163
  255,  0,170,     // 164
  255,  0,255,     // 165
  255, 31,255,     // 166
  255,127,255,     // 167
  255,159,255,     // 168
  255,191,255,     // 169
  255,223,255,     // 170
  204,223,255,     // 171
  204,255,255,     // 172
  153,255,255,     // 173
  153,223,255,     // 174
  153,191,255,     // 175
  153,159,255,     // 176
  153,127,255,     // 177
  153, 95,255,     // 178
  153, 63,255,     // 179
  153, 31,255,     // 180
  153,  0,255,     // 181
  204,  0,255,     // 182
  204, 31,255,     // 183
  204, 63,255,     // 184
  204, 95,255,     // 185
  204,127,255,     // 186
  204,159,255,     // 187
  204,191,255,     // 188
  102,191,255,     // 189
  102,223,255,     // 190
  102,255,255,     // 191
   51,255,255,     // 192
   51,223,255,     // 193
   51,191,255,     // 194
    12,12,204,     // 195
   51,127,255,     // 196
   51, 95,255,     // 197
   51, 63,255,     // 198
   51, 31,255,     // 199
   51,  0,255,     // 200
  102,  0,255,     // 201
  102, 31,255,     // 202
  102, 63,255,     // 203
  102, 95,255,     // 204
  102,127,255,     // 205
  102,159,255,     // 206
    0,159,255,     // 207
    0,191,255,     // 208
    0,223,255,     // 209
    0,255,255,     // 210
    0,127,255,     // 211
    0, 95,255,     // 212
   70,  0,  0,     // 213
    0, 31,255,     // 214
    0,  0,255,     // 215
  156, 60, 12,     // 216
  156,204, 60,     // 217
  108,204, 60,     // 218
   60,204, 60,     // 219
   12,204, 60,     // 220
   12,108, 60,     // 221
   12, 12,108,     // 222
   12, 12,204,     // 223
   12, 60,204,     // 224
   12,108,108,     // 225
   12,108,204,     // 226
   60,156,204,     // 227
   60,108,204,     // 228
   60, 12, 60,     // 229
  108, 12, 60,     // 230
  252, 60, 60,     // 231
  252,108, 60,     // 232
  156,108, 60,     // 233
  108,108, 60,     // 234
   60,108, 60,     // 235
   12,204,108,     // 236
   12,156,204,     // 237
   12,204,204,     // 238
   12,252,204,     // 239
   60,204,204,     // 240
  108,252, 60,     // 241
  108,252,108,     // 242
  108, 12,204,     // 243
   60, 12,204,     // 244
   60, 60,204,     // 245
  108, 60,204,     // 246
   60, 60,108,     // 247
  108,108,204,     // 248
  156, 12,204,     // 249
  252, 60,108,     // 250
  252,108,108,     // 251
  252,204, 60,     // 252
  108,252,204,     // 253
   60,252,204,     // 254
  108,204,204      // 255
};

// ----------------------------------------------------------------------- */
// -- ATTEND QUE LE FAISCEAU AIT FINI SON BOULOT (FEIGNANT) -------------- */
// ----------------------------------------------------------------------- */
void vertical_retrace(void);
#pragma aux vertical_retrace="mov dx,3dah","wait1: in al,dx","test al,8","jz wait1",modify[al dx];

// -----------------------------------------------------------------------
// --------- FADING DE LA PALETTE SVGA -----------------------------------
// -----------------------------------------------------------------------
void fading_palette(byte Fade) {
  #if !WINDOWS
  register int j,i;
  if (!OptFade && Fade==FADEIN) { palette_noire(); return; }
  if (!OptFade && Fade==FADEOUT) { put_palette(); return; }

  outp(0x3C6,0xFF);

  if (Fade) {
    for (j=100;j>1;j-=2) {
      delay(10);
      vertical_retrace();
      outp(0x3C8,0);
      for (i=0;i<NBC;i++) {
        outp(0x3C9,(((Palette[i][0]>>2)*j)/100));
        outp(0x3C9,(((Palette[i][1]>>2)*j)/100));
        outp(0x3C9,(((Palette[i][2]>>2)*j)/100));
      }
    }
  } else {
    outp(0x3C8,0);
    for (i=0;i<NBC;i++) {
      outp(0x3C9,0);
      outp(0x3C9,0);
      outp(0x3C9,0);
    }

    for (j=1;j<=100;j+=2) {
      delay(10);
      vertical_retrace();
      outp(0x3C8,0);
      for (i=0;i<NBC;i++) {
        outp(0x3C9,(((Palette[i][0]>>2)*j)/100));
        outp(0x3C9,(((Palette[i][1]>>2)*j)/100));
        outp(0x3C9,(((Palette[i][2]>>2)*j)/100));
      }
    }
  }
  #endif
}

// -----------------------------------------------------------------------
// --------- RECUPERE LA PALETTE SUR LE DAC ------------------------------
// -----------------------------------------------------------------------
void get_palette(void) {
  register int j;

  outp(0x3C6,0xFF);
  outp(0x3C7,0);

  for (j=0;j<NBC;j++) {
    Palette[j][0]=inp(0x3C9)<<2;
    Palette[j][1]=inp(0x3C9)<<2;
    Palette[j][2]=inp(0x3C9)<<2;
  }
}

// -----------------------------------------------------------------------
// --------- FORCE LA PALETTE SUR LE DAC ---------------------------------
// -----------------------------------------------------------------------
void put_palette(void) {
  #if !WINDOWS
  register int i;

  outp(0x3C6,0xFF);
  outp(0x3C8,0);

  for (i=0;i<NBC;i++) {
    outp(0x3C9,0);
    outp(0x3C9,0);
    outp(0x3C9,0);
  }

  outp(0x3C6,0xFF);
  outp(0x3C8,0);

  for (i=0;i<NBC;i++) {
    outp(0x3C9,Palette[i][0]>>2);
    outp(0x3C9,Palette[i][1]>>2);
    outp(0x3C9,Palette[i][2]>>2);
  }
  #endif
}

// -----------------------------------------------------------------------
// --------- PASSE LA PALETTE AU NOIR ------------------------------------
// -----------------------------------------------------------------------
void palette_noire(void) {
  #if !WINDOWS
  register int j;
  outp(0x3C6,0xFF);
  outp(0x3C7,0);

  for (j=0;j<NBC;j++) {
    outp(0x3C9,0);
    outp(0x3C9,0);
    outp(0x3C9,0);
  }
  #endif
}

// -----------------------------------------------------------------------
// --------- MODIFIE UNE ENTREE DE LA PALETTE ----------------------------
// -----------------------------------------------------------------------
void modif_entree_palette(byte Num,byte R,byte V,byte B) {
  Palette[Num][0]=R;
  Palette[Num][1]=V;
  Palette[Num][2]=B;

  #if !WINDOWS
    regs.w.ax=0x1010;
    regs.w.bx=Num;
    regs.w.cx=(256*(Palette[Num][_V]>>2))+(Palette[Num][_B]>>2);
    regs.w.dx=256*(Palette[Num][_R]>>2);
    int386(0x10,&regs,&regs);
  #endif
}

